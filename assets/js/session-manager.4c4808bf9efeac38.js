"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[967],{88233:(e,t,s)=>{s.d(t,{setupAgentSession:()=>T});var i=s(12525),r=s(64266),n=s(80326),a=s(47468),h=s(87516),o=s(29452);class u{constructor(e,t){if(!e.onEnd)throw Error("onEnd handler is required");if(!t)throw Error("ms duration is required");this.onEnd=e.onEnd,this.initialMs=t,this.startTimestamp=Date.now(),this.timer=this.create(this.onEnd,t)}create(e,t){return this.timer&&this.clear(),setTimeout(()=>e?e():this.onEnd(),t||this.initialMs)}clear(){clearTimeout(this.timer),this.timer=null}end(){this.clear(),this.onEnd()}isValid(){return this.initialMs-(Date.now()-this.startTimestamp)>0}}var c=s(8068),l=s(26196),d=s(9219),m=s(62719);class f extends u{constructor(e,t){super(e,t),this.onPause="function"==typeof e.onPause?e.onPause:()=>{},this.onRefresh="function"==typeof e.onRefresh?e.onRefresh:()=>{},this.onResume="function"==typeof e.onResume?e.onResume:()=>{},this.readStorage=e.readStorage,this.remainingMs=void 0,e.refreshEvents||(e.refreshEvents=["click","keydown","scroll"]);try{this.abortController=new AbortController}catch(e){}if(c.RI&&e.ee){if(e.ee){this.ee=e.ee;let t=(0,m.s)(this.refresh.bind(this),500,{leading:!0});this.refreshHandler=s=>{e.refreshEvents.includes(s?.[0]?.type)&&t()},e.ee.on("fn-end",this.refreshHandler)}(0,d.u)(e=>{"hidden"===e?this.pause():this.resume()},!1,!1,this.abortController?.signal)}}abort(){this.clear(),this.abortController?.abort(),this.refreshHandler&&(this.ee.removeEventListener("fn-end",this.refreshHandler),this.refreshHandler=this.ee=null)}pause(){this.onPause(),clearTimeout(this.timer),this.remainingMs=this.initialMs-(Date.now()-this.startTimestamp)}resume(){try{let t=this.readStorage(),s="string"==typeof t?JSON.parse(t):t;e(s.expiresAt)||e(s.inactiveAt)?this.end():(this.refresh(),this.onResume())}catch(e){this.end()}function e(e){return Date.now()>e}}refresh(e,t){this.clear(),this.timer=this.create(e,t),this.startTimestamp=Date.now(),this.remainingMs=void 0,this.onRefresh()}}var p=s(19603),g=s(94204),v=s(48532),y=s(94581),S=s(56804),w=s(89578),A=s(98183);let M={value:"",inactiveAt:0,expiresAt:0,updatedAt:Date.now(),sessionReplayMode:l.g.OFF,sessionReplaySentFirstChunk:!1,sessionTraceMode:l.g.OFF,traceHarvestStarted:!1,loggingMode:A.A$.OFF,serverTimeDiff:null,custom:{},numOfResets:0};class E{constructor(e){let{agentIdentifier:t,key:s,storage:i}=e;if(!t||!s||!i)throw Error("Missing required field(s):".concat(t?"":" agentID").concat(s?"":" key").concat(i?"":" storage"));this.agentIdentifier=t,this.storage=i,this.state={},this.key=s,this.ee=r.ee.get(t),(0,p.u)(this.ee),this.setup(e),c.RI&&(0,w.sp)("storage",e=>{if(e.key===this.lookupKey){let t="string"==typeof e.newValue?JSON.parse(e.newValue):e.newValue;this.sync(t),this.ee.emit(l.tS.UPDATE,[l.iL.CROSS_TAB,this.state])}})}setup({value:e=(0,a.LA)(16),expiresMs:t=l.wk,inactiveMs:s=l.BB,numOfResets:i=0}){let r={serverTimeDiff:this.state.serverTimeDiff||M.serverTimeDiff};this.state={},this.sync({...M,...r}),this.state.value=e,this.expiresMs=t,this.inactiveMs=s;let n=this.read();t?(this.state.expiresAt=n?.expiresAt||this.getFutureTimestamp(t),this.state.numOfResets=n?.numOfResets||i,this.expiresTimer=new u({onEnd:()=>{this.collectSM("expired"),this.collectSM("duration"),this.reset()}},this.state.expiresAt-Date.now())):this.state.expiresAt=1/0,s?(this.state.inactiveAt=n?.inactiveAt||this.getFutureTimestamp(s),this.inactiveTimer=new f({onEnd:()=>{this.collectSM("inactive"),this.collectSM("duration"),this.reset()},onRefresh:this.refresh.bind(this),onResume:()=>{this.ee.emit(l.tS.RESUME)},onPause:()=>{this.initialized&&this.ee.emit(l.tS.PAUSE),this.write((0,g.a)(this.state,M))},ee:this.ee,refreshEvents:["click","keydown","scroll"],readStorage:()=>this.storage.get(this.lookupKey)},this.state.inactiveAt-Date.now())):this.state.inactiveAt=1/0,this.isNew||=!Object.keys(n).length,this.isNew?this.write((0,g.a)(this.state,M),!0):this.sync(n),this.initialized=!0,this.ee.emit(l.tS.STARTED,[this.isNew])}get lookupKey(){return"".concat(l.H3,"_").concat(this.key)}sync(e){Object.assign(this.state,e)}read(){try{let e=this.storage.get(this.lookupKey);if(!e)return{};let t="string"==typeof e?JSON.parse(e):e;if(this.isInvalid(t))return{};if(this.isExpired(t.expiresAt))return this.collectSM("expired"),this.collectSM("duration",t,!0),this.reset();if(this.isExpired(t.inactiveAt))return this.collectSM("inactive"),this.collectSM("duration",t,!0),this.reset();return t}catch(e){return(0,h.R)(10,e),{}}}write(e){try{if(!e||"object"!=typeof e)return;return e.updatedAt=Date.now(),this.sync(e),this.storage.set(this.lookupKey,(0,o.A)(this.state)),this.ee.emit(l.tS.UPDATE,[l.iL.SAME_TAB,this.state]),e}catch(e){return(0,h.R)(11,e),null}}reset(){try{return this.initialized&&(this.ee.emit(l.tS.RESET),this.state.numOfResets++),this.storage.remove(this.lookupKey),this.inactiveTimer?.abort?.(),this.expiresTimer?.clear?.(),delete this.isNew,this.setup({agentIdentifier:this.agentIdentifier,key:this.key,storage:this.storage,expiresMs:this.expiresMs,inactiveMs:this.inactiveMs,numOfResets:this.state.numOfResets}),this.read()}catch(e){return{}}}refresh(){let e=this.read();this.write({...e,inactiveAt:this.getFutureTimestamp(this.inactiveMs)})}isExpired(e){return Date.now()>e}isInvalid(e){return!Object.keys(M).every(t=>Object.keys(e).includes(t))}collectSM(e,t,s){let i,r;"duration"===e&&(i=this.getDuration(t,s),r="Session/Duration/Ms"),"expired"===e&&(r="Session/Expired/Seen"),"inactive"===e&&(r="Session/Inactive/Seen"),r&&(0,v.p)(y.xV,[r,i],void 0,S.K7.metrics,this.ee)}getDuration(e=this.state,t){let s=e.expiresAt-this.expiresMs;return(t?Date.now():e.updatedAt)-s}getFutureTimestamp(e){return Date.now()+e}syncCustomAttribute(e,t){if(c.RI){if(null===t){let t=this.read();t.custom&&(delete t.custom[e],this.write({...t}))}else{let s=this.read();this.custom={...s?.custom||{},[e]:t},this.write({...s,custom:this.custom})}}}}class R{get(e){try{return localStorage.getItem(e)||void 0}catch(e){return""}}set(e,t){try{if(null==t)return this.remove(e);return localStorage.setItem(e,t)}catch(e){}}remove(e){try{localStorage.removeItem(e)}catch(e){}}}function T(e){if(e.runtime.session)return e.runtime.session;let t=e.init.session;e.runtime.session=new E({agentIdentifier:e.agentIdentifier,key:l.uh,storage:new R,expiresMs:t?.expiresMs,inactiveMs:t?.inactiveMs});let s=e.runtime.session.state.custom;s&&(e.info.jsAttributes={...s,...e.info.jsAttributes});let a=r.ee.get(e.agentIdentifier);return(0,n.i)("api-setCustomAttribute",(t,s,i)=>{e.runtime.session.syncCustomAttribute(s,i)},"session",a),(0,n.i)("api-setUserId",(t,s,i)=>{e.runtime.session.syncCustomAttribute(s,i)},"session",a),(0,i.Ze)(e.agentIdentifier,"session"),e.runtime.session}}}]);